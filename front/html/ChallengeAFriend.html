<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends List</title>
</head>
<body>
    <h1>Friends List</h1>
    <div id="friendsList"></div>
    <script src="../js/socket.io.js"></script>
    <script>
        // Function to fetch friends with messages
        const io_instance = io("/api/OnlineGame", {
            query: { 
            cookies: document.cookie
            }
        });
        function fetchFriendsWithMessages() {
            // Assuming you have an API endpoint to fetch friends with messages
            console.log("get frieeeeeends")
            fetch('/api/user/friends')
            .then(response => response.json())
            .then(friends => {
                // Get reference to the friends list container
                const friendsListContainer = document.getElementById('friendsList');
                
                // Create HTML content for the list of friends
                let htmlContent = "<ul>";

                // Loop through friends and create list items with "Challenge Friend" button
                friends.forEach(friend => {
                    htmlContent += `<li>${friend.username} <button onclick="challengeFriend('${friend.username}')">Challenge</button></li>`;
                });

                htmlContent += "</ul>";

                // Set HTML content in the friends list container
                friendsListContainer.innerHTML = htmlContent;
            })
            .catch(error => {
                console.error('Error fetching friends with messages:', error);
                alert('Error fetching friends with messages. Please try again later.');
            });
        }


        io_instance.on("challengeRecieved",(roomId)=>{
            console.log("reciveeddd A chanllenge");
            const confirmation = window.confirm("You have received a challenge from "+roomId +". Do you want to accept it?");
            if (confirmation==true) {
                console.log("Challenge accepted");
                // Your code for when the challenge is accepted
                var url = 'http://localhost:8000/html/OnlineGame.html?challenge='+roomId;
                window.location.href = url;
            } else {
                console.log("Challenge refused");
                io_instance.emit("challengeRejected",roomId);
                
                // Your code for when the challenge is refused
            }

        })


        io_instance.on("userNotConnected",()=>{
        window.alert("user not Connected")
        
        })
        // Function to handle challenging a friend
        function challengeFriend(friendId) {
            // Emit the event to the server
            io_instance.emit("ChallengeGame", friendId, (response) => {
                console.log("server response ",response);
                // This callback function will be executed when the server responds
                if (response === "success") {
                    // If the server acknowledges the challenge, redirect the user
                    var url = `http://localhost:8000/html/OnlineGame.html?challenge=true`;
                    window.location.href = url;
                } else {
                    // Handle other cases, if necessary
                    console.log("Challenge failed");
                }
            });
        }
        // Call the function to fetch friends when the page loads
        window.onload = fetchFriendsWithMessages;
    </script>
</body>
</html>
